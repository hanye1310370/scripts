redis主从复制的原理-redis集群管理
2016-07-19| 发布: | 浏览: 743 |保存PDF
复制的过程原理
1、 当从库和主库建立master-slave关系后，会向主数据库发送SYNC命令；
2、 主库接收到SYNC命令后会开始在后台保存快照（RDB持久化过程），并将期间接收到的写命令缓存起来；
3、 当快照完成后，主Redis会将快照文件和所有缓存的写命令发送给从Redis；
4、 从Redis接收到后，会载入快照文件并且执行收到的缓存的命令；
5、 之后，主Redis每当接收到 写命令时就会将命令发送从Redis，从而保证数据的一致；

无磁盘复制
通过前面的复制过程我们了解到，主库接收到SYNC的命令时会执行RDB过程，即使在配置文件中禁用RDB持久化也会生成，那么如果主库所在的服务器磁盘IO性能较差，那么这个复制过程就会出现瓶颈，庆幸的是，Redis在2.8.18版本开始实现了无磁盘复制功能。

无磁盘复制原理：
Redis在与从数据库进行复制初始化时将不会将快照存储到磁盘，而是直接通过网络发送给从数据库，避免了IO性能差问题。

开启无磁盘复制：repl-diskless-sync yes

复制架构中出现宕机情况，怎么办？
如果在主从复制架构中出现宕机的情况，需要分情况看：
1、 从Redis宕机
a) 这个相对而言比较简单，在Redis中从库重新启动后会自动加入到主从架构中，自动完成同步数据；
b) 如果从库在断开期间，主库的变化不大，从库再次启动后，主库依然会将所有的数据做RDB操作吗？还是增量更新？（从库有做持久化的前提下）
i. 不会的，因为在Redis2.8版本后就实现了，主从断线后恢复的情况下实现增量复制。
2、 主Redis宕机
a) 这个相对而言就会复杂一些，需要以下2步才能完成
i. 第一步，在从数据库中执行SLAVEOF NO ONE命令，断开主从关系并且把从Redis提升为主库继续服务；
ii. 第二步，将主库重新启动后，执行SLAVEOF命令，将其设置为其他库的从库，这时数据就能更新回来；
b) 这个手动完成恢复的过程其实是比较麻烦的并且容易出错，有没有好办法解决呢？当前有的，Redis提高的哨兵（sentinel）的功能。